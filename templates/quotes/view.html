{% extends "base.html" %}

{% block title %}Quote {{ quote.quote_number }} - VCore{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-text"></i> Quote {{ quote.quote_number }}</h2>
    <div>
        <a href="{{ url_for('quote_edit', id=quote.id) }}" class="btn btn-warning">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <a href="{{ url_for('quote_print', id=quote.id) }}" class="btn btn-success" target="_blank">
            <i class="bi bi-printer"></i> Print/Save PDF
        </a>
        <form method="POST" action="{{ url_for('quote_duplicate', id=quote.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-info">
                <i class="bi bi-files"></i> Duplicate
            </button>
        </form>
        {% if current_user.is_admin() %}
        <form method="POST" action="{{ url_for('quote_delete', id=quote.id) }}" style="display: inline;"
            onsubmit="return confirm('Are you sure you want to delete this quote?');">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('quotes_list') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="row">
    <!-- Quote Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Quote Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th style="width: 40%">Quote Number:</th>
                        <td><strong>{{ quote.quote_number }}</strong></td>
                    </tr>
                    <tr>
                        <th>Quote Date:</th>
                        <td>{{ quote.quote_date.strftime('%d %B %Y') }}</td>
                    </tr>
                    <tr>
                        <th>Expected Date:</th>
                        <td>{{ quote.expected_date.strftime('%d %B %Y') if quote.expected_date else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th>Status:</th>
                        <td>
                            <span class="badge bg-{{ quote.get_status_badge_class() }}">
                                {{ quote.status }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Created By:</th>
                        <td>{{ quote.creator.username }}</td>
                    </tr>
                    <tr>
                        <th>Created At:</th>
                        <td>{{ quote.created_at.strftime('%d %B %Y %I:%M %p') }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Customer Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Customer Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th style="width: 40%">Name:</th>
                        <td><strong>{{ quote.customer_name }}</strong></td>
                    </tr>
                    {% if quote.customer_address %}
                    <tr>
                        <th>Address:</th>
                        <td>{{ quote.customer_address }}</td>
                    </tr>
                    {% endif %}
                    {% if quote.customer_city or quote.customer_state %}
                    <tr>
                        <th>Location:</th>
                        <td>{{ quote.customer_city }}{% if quote.customer_city and quote.customer_state %}, {% endif
                            %}{{ quote.customer_state }}</td>
                    </tr>
                    {% endif %}
                    {% if quote.customer_phone %}
                    <tr>
                        <th>Phone:</th>
                        <td>{{ quote.customer_phone }}</td>
                    </tr>
                    {% endif %}
                    {% if quote.customer_email %}
                    <tr>
                        <th>Email:</th>
                        <td>{{ quote.customer_email }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Line Items -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Line Items</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 25%">Particular</th>
                        <th style="width: 10%">Actual Size</th>
                        <th style="width: 10%">Chargeable Size</th>
                        <th style="width: 8%">Unit</th>
                        <th style="width: 8%">Qty</th>
                        <th style="width: 10%">Unit Sq</th>
                        <th style="width: 12%">Rate/Sq</th>
                        <th style="width: 12%">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% set ns = namespace(group_num=0) %}
                    {% for item in quote.items if not item.parent_id %}
                    {% set ns.group_num = ns.group_num + 1 %}
                    {% if item.is_group %}
                    <!-- Group Row -->
                    <tr class="table-secondary">
                        <td><strong>{{ ns.group_num }}</strong></td>
                        <td colspan="8"><strong>{{ item.particular }}</strong></td>
                    </tr>

                    <!-- Sub-items -->
                    {% set sub_items = item.children|sort(attribute='sort_order') %}
                    {% for sub_item in sub_items %}
                    <tr>
                        <td>&nbsp;</td>
                        <td style="padding-left: 30px;">{{ sub_item.particular }}</td>
                        <td>
                            {% if sub_item.actual_width and sub_item.actual_height %}
                            {{ sub_item.actual_width }} × {{ sub_item.actual_height }}
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if sub_item.chargeable_width and sub_item.chargeable_height %}
                            {{ sub_item.chargeable_width }} × {{ sub_item.chargeable_height }}
                            {% else %}-{% endif %}
                        </td>
                        <td>{{ sub_item.unit or 'MM' }}</td>
                        <td>{{ sub_item.quantity }}</td>
                        <td>{{ "{:.4f}".format(sub_item.unit_square) if sub_item.unit_square else '-' }}</td>
                        <td>₹{{ "{:,.2f}".format(sub_item.rate_sqper) }}</td>
                        <td>₹{{ "{:,.2f}".format(sub_item.total) }}</td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <!-- Regular item (no group) -->
                    <tr>
                        <td>{{ ns.group_num }}</td>
                        <td>{{ item.particular }}</td>
                        <td>
                            {% if item.actual_width and item.actual_height %}
                            {{ item.actual_width }} × {{ item.actual_height }}
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if item.chargeable_width and item.chargeable_height %}
                            {{ item.chargeable_width }} × {{ item.chargeable_height }}
                            {% else %}-{% endif %}
                        </td>
                        <td>{{ item.unit or 'MM' }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ "{:.4f}".format(item.unit_square) if item.unit_square else '-' }}</td>
                        <td>₹{{ "{:,.2f}".format(item.rate_sqper) }}</td>
                        <td>₹{{ "{:,.2f}".format(item.total) }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Totals -->
<div class="row">
    <div class="col-md-6 offset-md-6">
        <div class="card">
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <td><strong>Subtotal:</strong></td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.subtotal) }}</td>
                    </tr>
                    {% if quote.delivery_charges > 0 %}
                    <tr>
                        <td>Delivery Charges:</td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.delivery_charges) }}</td>
                    </tr>
                    {% endif %}
                    {% if quote.installation_charges > 0 %}
                    <tr>
                        <td>Installation Charges:</td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.installation_charges) }}</td>
                    </tr>
                    {% endif %}
                    {% if quote.freight_charges > 0 %}
                    <tr>
                        <td>Freight Charges:</td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.freight_charges) }}</td>
                    </tr>
                    {% endif %}
                    {% if quote.transport_charges > 0 %}
                    <tr>
                        <td>Transport Charges:</td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.transport_charges) }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>GST ({{ quote.gst_percentage }}%):</strong></td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.gst_amount) }}</td>
                    </tr>
                    <tr>
                        <td>Round Off:</td>
                        <td class="text-end">₹{{ "{:,.2f}".format(quote.round_off) }}</td>
                    </tr>
                    <tr class="table-active">
                        <td><strong>Total:</strong></td>
                        <td class="text-end"><strong>₹{{ "{:,.2f}".format(quote.total) }}</strong></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Payment Terms -->
{% if quote.payment_terms %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Payment Terms</h5>
    </div>
    <div class="card-body">
        <p class="mb-0">{{ quote.payment_terms }}</p>
    </div>
</div>
{% endif %}
{% endblock %}