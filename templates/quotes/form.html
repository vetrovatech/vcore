{% extends "base.html" %}

{% block title %}{{ 'Edit Quote' if quote else 'New Quote' }} - VCore{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-text"></i> {{ 'Edit Quote' if quote else 'New Quote' }}</h2>
    <a href="{{ url_for('quotes_list') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<form method="POST" id="quoteForm">
    <!-- Customer Information -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Customer Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" name="customer_name"
                            value="{{ quote.customer_name if quote else '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="customer_address"
                            rows="2">{{ quote.customer_address if quote else '' }}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="customer_city"
                                value="{{ quote.customer_city if quote else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" name="customer_state"
                                value="{{ quote.customer_state if quote else '' }}">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" name="customer_phone"
                            value="{{ quote.customer_phone if quote else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="customer_email"
                            value="{{ quote.customer_email if quote else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dispatch To</label>
                        <textarea class="form-control" name="dispatch_to"
                            rows="2">{{ quote.dispatch_to if quote else '' }}</textarea>
                        <small class="text-muted">Leave blank to use customer address</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Details -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Quote Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Quote Date *</label>
                    <input type="date" class="form-control" name="quote_date"
                        value="{{ quote.quote_date.strftime('%Y-%m-%d') if quote else '' }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Expected Date</label>
                    <input type="date" class="form-control" name="expected_date"
                        value="{{ quote.expected_date.strftime('%Y-%m-%d') if quote and quote.expected_date else '' }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="Draft" {{ 'selected' if quote and quote.status=='Draft' else '' }}>Draft</option>
                        <option value="Sent" {{ 'selected' if quote and quote.status=='Sent' else '' }}>Sent</option>
                        <option value="Accepted" {{ 'selected' if quote and quote.status=='Accepted' else '' }}>Accepted
                        </option>
                        <option value="Rejected" {{ 'selected' if quote and quote.status=='Rejected' else '' }}>Rejected
                        </option>
                        <option value="Expired" {{ 'selected' if quote and quote.status=='Expired' else '' }}>Expired
                        </option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Quote Type</label>
                    <select class="form-select" name="quote_type" {{ 'disabled' if quote else '' }}>
                        <option value="B2B" {{ 'selected' if quote and quote.quote_type=='B2B' else 'selected' }}>B2B
                        </option>
                        <option value="B2C" {{ 'selected' if quote and quote.quote_type=='B2C' else '' }}>B2C</option>
                    </select>
                    {% if quote %}
                    <input type="hidden" name="quote_type" value="{{ quote.quote_type }}">
                    <small class="text-muted">Quote type cannot be changed after creation</small>
                    {% endif %}
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">
                        <input type="checkbox" name="self_pickup" {{ 'checked' if quote and quote.self_pickup else ''
                            }}>
                        Self Pickup
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Line Items -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Line Items</h5>
            <button type="button" class="btn btn-sm btn-light" onclick="addGroup()">
                <i class="bi bi-plus-circle"></i> Add Group
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm mb-0" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">S.No</th>
                            <th style="width: 15%;">Particular</th>
                            <th style="width: 8%;">Actual W</th>
                            <th style="width: 8%;">Actual H</th>
                            <th style="width: 6%;">Unit</th>
                            <th style="width: 8%;">Charge W</th>
                            <th style="width: 8%;">Charge H</th>
                            <th style="width: 6%;">Qty</th>
                            <th style="width: 8%;">Area (Sq Mtr)</th>
                            <th style="width: 10%;">Rate / Sq Mtr</th>
                            <th style="width: 10%;">Total</th>
                            <th style="width: 8%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- Items will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charges and Totals -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Additional Charges</h6>
                </div>
                <div class="card-body">
                    <div class="row">

                        <div class="col-md-6 mb-2">
                            <label class="form-label">Installation Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="installation_charges"
                                name="installation_charges" value="{{ quote.installation_charges if quote else 0 }}">
                        </div>

                        <div class="col-md-6 mb-2">
                            <label class="form-label">Transport Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="transport_charges"
                                name="transport_charges" value="{{ quote.transport_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Cutout Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="cutout_charges"
                                name="cutout_charges" value="{{ quote.cutout_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Holes Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="holes_charges"
                                name="holes_charges" value="{{ quote.holes_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Shape Cutting Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input"
                                id="shape_cutting_charges" name="shape_cutting_charges"
                                value="{{ quote.shape_cutting_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Jumbo Size Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="jumbo_size_charges"
                                name="jumbo_size_charges" value="{{ quote.jumbo_size_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Template Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="template_charges"
                                name="template_charges" value="{{ quote.template_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Handling Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="handling_charges"
                                name="handling_charges" value="{{ quote.handling_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Polish Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="polish_charges"
                                name="polish_charges" value="{{ quote.polish_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Document Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="document_charges"
                                name="document_charges" value="{{ quote.document_charges if quote else 0 }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Frosted Charges</label>
                            <input type="number" step="0.01" class="form-control charge-input" id="frosted_charges"
                                name="frosted_charges" value="{{ quote.frosted_charges if quote else 0 }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Totals</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <td>Subtotal:</td>
                            <td class="text-end"><strong id="subtotal_display">0.00</strong></td>
                        </tr>
                        <tr>
                            <td>
                                GST
                                <input type="number" step="0.01" class="form-control form-control-sm d-inline-block"
                                    id="gst_percentage" name="gst_percentage"
                                    value="{{ quote.gst_percentage if quote else 18 }}" style="width: 60px;"> %
                            </td>
                            <td class="text-end"><strong id="gst_display">0.00</strong></td>
                        </tr>
                        <tr>
                            <td>Round Off:</td>
                            <td class="text-end"><strong id="roundoff_display">0.00</strong></td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>Total:</strong></td>
                            <td class="text-end"><strong id="total_display">0.00</strong></td>
                        </tr>
                    </table>

                    <!-- Hidden fields for form submission -->
                    <input type="hidden" id="subtotal" name="subtotal">
                    <input type="hidden" id="gst_amount" name="gst_amount">
                    <input type="hidden" id="round_off" name="round_off">
                    <input type="hidden" id="total" name="total">
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Terms -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">Payment Terms</h6>
        </div>
        <div class="card-body">
            <textarea class="form-control" name="payment_terms"
                rows="3">{{ quote.payment_terms if quote else 'For Confirmation the order need to give 100% of Quotation Value' }}</textarea>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="mb-5">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-save"></i> Save Quote
        </button>
        <a href="{{ url_for('quotes_list') }}" class="btn btn-secondary btn-lg">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
    </div>
</form>

{%if quote%}
<script>
    // Pre-populate existing items when editing
    window.existingQuoteData = {
        items: [
            {%for item in quote.items if not item.parent_id %}
    {
        id: {{item.id}},
        is_group: {{'true' if item.is_group else 'false'}},
        item_number: {{item.item_number}},
        particular: "{{item.particular|replace('"', '\\"')}}",
            actual_width: {{item.actual_width if item.actual_width else 'null'}},
        actual_height: {{item.actual_height if item.actual_height else 'null'}},
        chargeable_width: {{item.chargeable_width if item.chargeable_width else 'null'}},
        chargeable_height: {{item.chargeable_height if item.chargeable_height else 'null'}},
        unit: "{{item.unit or 'MM'}}",
            quantity: {{item.quantity}},
        unit_square: {{item.unit_square if item.unit_square else 0}},
        rate_sqper: {{item.rate_sqper}},
        total: {{item.total}},
        chargeable_extra: {{item.chargeable_extra if item.chargeable_extra else 30}},
        children: [
            {%if item.is_group %}
    {%for child in item.children | sort(attribute = 'sort_order') %}
    {
        id: {{child.id}},
        particular: "{{child.particular|replace('"', '\\"')}}",
            actual_width: {{child.actual_width if child.actual_width else 'null'}},
        actual_height: {{child.actual_height if child.actual_height else 'null'}},
        chargeable_width: {{child.chargeable_width if child.chargeable_width else 'null'}},
        chargeable_height: {{child.chargeable_height if child.chargeable_height else 'null'}},
        unit: "{{child.unit or 'MM'}}",
            quantity: {{child.quantity}},
        unit_square: {{child.unit_square if child.unit_square else 0}},
        rate_sqper: {{child.rate_sqper}},
        total: {{child.total}}
    } {{',' if not loop.last else ''}}
    {% endfor %}
    {% endif %}
            ]
        }{{',' if not loop.last else ''}}
    {% endfor %}
    ]
};
</script>
{% endif %}

<script src="{{ url_for('static', filename='js/quote_form_enhanced.js') }}"></script>
{% endblock %}