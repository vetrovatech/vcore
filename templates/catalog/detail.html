{% extends "base.html" %}

{% block title %}{{ product.product_name }} - VCore{% endblock %}

{% block extra_css %}
<style>
    .product-grid-image {
        height: 200px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 2px solid #e2e8f0;
    }

    .image-container {
        position: relative;
        overflow: hidden;
        border-radius: 0.5rem;
    }

    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .image-container:hover .image-overlay {
        opacity: 1;
    }

    .image-number {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(102, 126, 234, 0.9);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .spec-table th {
        width: 30%;
        background-color: #f8fafc;
        font-weight: 600;
    }

    .product-header {
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
    <a href="{{ url_for('catalog_list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Catalog
    </a>

    <div class="btn-group">
        {% if prev_product %}
        <a href="{{ url_for('catalog_detail', id=prev_product.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-chevron-left"></i> Previous
        </a>
        {% else %}
        <button class="btn btn-outline-secondary" disabled>
            <i class="bi bi-chevron-left"></i> Previous
        </button>
        {% endif %}

        {% if next_product %}
        <a href="{{ url_for('catalog_detail', id=next_product.id) }}" class="btn btn-outline-primary">
            Next <i class="bi bi-chevron-right"></i>
        </a>
        {% else %}
        <button class="btn btn-outline-secondary" disabled>
            Next <i class="bi bi-chevron-right"></i>
        </button>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Product Images Grid -->
    <div class="col-md-6">
        <h5 class="mb-3"><i class="bi bi-images"></i> Product Images</h5>
        <div class="row g-2">
            {% for i in range(1, 5) %}
            {% set image_url = product['image_' ~ i ~ '_url'] %}
            <div class="col-6">
                <div class="image-container">
                    <img src="{{ image_url if image_url else 'https://via.placeholder.com/300x300?text=No+Image' }}"
                        class="product-grid-image w-100" alt="Product image {{ i }}" id="product-image-{{ i }}"
                        onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
                    {% if current_user.is_manager_or_admin() %}
                    <div class="image-overlay">
                        <button type="button" class="btn btn-sm btn-primary"
                            onclick="document.getElementById('upload-{{ i }}').click()">
                            <i class="bi bi-upload"></i> Replace
                        </button>
                        <input type="file" id="upload-{{ i }}" name="image" accept="image/*"
                            onchange="uploadImage({{ i }}, {{ product.id }})" style="display: none;">
                    </div>
                    {% endif %}
                    <div class="image-number">{{ i }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Product Details -->
    <div class="col-md-6">
        <div class="product-header">
            <span class="badge bg-primary mb-2">{{ product.category }}</span>
            <h2>{{ product.product_name }}</h2>
            {% if product.brand %}
            <p class="text-muted mb-2">
                <i class="bi bi-award"></i> <strong>Brand:</strong> {{ product.brand }}
            </p>
            {% endif %}
            <h3 class="text-primary">{{ product.get_formatted_price() }}</h3>
            {% if product.availability %}
            <span class="badge bg-success">{{ product.availability }}</span>
            {% endif %}
        </div>

        {% if product.description %}
        <div class="mb-4">
            <h5><i class="bi bi-file-text"></i> Description</h5>
            <p class="text-muted">{{ product.description }}</p>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="d-flex gap-2 mb-4">
            {% if product.product_url %}
            <a href="{{ product.product_url }}" target="_blank" class="btn btn-outline-primary">
                <i class="bi bi-box-arrow-up-right"></i> View on IndiaMART
            </a>
            {% endif %}

            {% if current_user.is_manager_or_admin() %}
            <a href="{{ url_for('catalog_edit', id=product.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-pencil"></i> Edit Details
            </a>
            {% endif %}

            {% if current_user.is_admin() %}
            <form method="POST" action="{{ url_for('catalog_delete', id=product.id) }}"
                onsubmit="return confirm('Are you sure you want to delete this product?')" class="d-inline">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </form>
            {% endif %}
        </div>

        <!-- Specifications -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Specifications</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm spec-table mb-0">
                    <tbody>
                        {% if product.material %}
                        <tr>
                            <th>Material</th>
                            <td>{{ product.material }}</td>
                        </tr>
                        {% endif %}
                        {% if product.thickness %}
                        <tr>
                            <th>Thickness</th>
                            <td>{{ product.thickness }}</td>
                        </tr>
                        {% endif %}
                        {% if product.shape %}
                        <tr>
                            <th>Shape</th>
                            <td>{{ product.shape }}</td>
                        </tr>
                        {% endif %}
                        {% if product.pattern %}
                        <tr>
                            <th>Pattern</th>
                            <td>{{ product.pattern }}</td>
                        </tr>
                        {% endif %}
                        {% if product.usage_application %}
                        <tr>
                            <th>Usage/Application</th>
                            <td>{{ product.usage_application }}</td>
                        </tr>
                        {% endif %}

                        {% set specs = product.get_specifications() %}
                        {% for key, value in specs.items() %}
                        <tr>
                            <th>{{ key }}</th>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function uploadImage(imageNum, productId) {
        const fileInput = document.getElementById(`upload-${imageNum}`);
        const file = fileInput.files[0];

        if (!file) return;

        // Show loading state
        const container = fileInput.closest('.image-container');
        const overlay = container.querySelector('.image-overlay');
        overlay.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Uploading...</span></div>';
        overlay.style.opacity = '1';

        // Create form data
        const formData = new FormData();
        formData.append('image', file);

        // Upload via AJAX
        fetch(`/catalog/${productId}/upload-image/${imageNum}`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update image
                    const img = document.getElementById(`product-image-${imageNum}`);
                    img.src = data.url + '?t=' + new Date().getTime(); // Cache bust

                    // Show success message
                    overlay.innerHTML = '<div class="text-light"><i class="bi bi-check-circle"></i> Uploaded!</div>';
                    setTimeout(() => {
                        overlay.innerHTML = '<button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById(\'upload-' + imageNum + '\').click()"><i class="bi bi-upload"></i> Replace</button>';
                        overlay.style.opacity = '0';
                    }, 2000);

                    // Show flash message
                    showFlashMessage('Image ' + imageNum + ' uploaded successfully!', 'success');
                } else {
                    overlay.innerHTML = '<div class="text-danger"><i class="bi bi-x-circle"></i> Failed</div>';
                    setTimeout(() => {
                        overlay.innerHTML = '<button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById(\'upload-' + imageNum + '\').click()"><i class="bi bi-upload"></i> Replace</button>';
                        overlay.style.opacity = '0';
                    }, 2000);
                    showFlashMessage(data.error || 'Upload failed', 'danger');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                overlay.innerHTML = '<div class="text-danger"><i class="bi bi-x-circle"></i> Error</div>';
                setTimeout(() => {
                    overlay.innerHTML = '<button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById(\'upload-' + imageNum + '\').click()"><i class="bi bi-upload"></i> Replace</button>';
                    overlay.style.opacity = '0';
                }, 2000);
                showFlashMessage('Upload error occurred', 'danger');
            });
    }

    function showFlashMessage(message, category) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }
</script>
{% endblock %}